<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}" />
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1 class="small-header">FAMILY FINANCE TRACKER</h1>
    <nav>
      <button id="expense-btn" class="hover-effect">Expense Management</button>
      <button id="budget-btn" class="hover-effect">Budget & Savings Management</button>
      <button id="insights-btn" class="hover-effect">Insights Dashboard</button>
      <span id="user-greeting">Hello, {{ username }}</span>
      <button id="dark-mode-toggle">üåô</button>
      <!-- Updated Logout Button in Header -->
      <a href="{{ url_for('logout') }}" class="logout-btn">LOGOUT</a>
    </nav>
  </header>

  <!-- RANDOM MESSAGES -->
  <div id="message-container">
    <div id="message"></div>
  </div>

  <!-- STATS SECTION -->
  <section class="stats">
    <div class="box green" id="total-spent">
      Total Spentüí∞
      <div>‚Çπ:<span id="total-spent-value">0</span></div>
    </div>
    <div class="box pink" id="expense-count">
      Expense Countüìä
      <div><span id="expense-count-value">0</span></div>
    </div>
    <div class="box blue" id="Last-7day-Spent">
      Last 7 DaysüìÖ
      <div>‚Çπ:<span id="last-7days-spent-value">0</span></div>
    </div>
    <div class="box gray" id="highest-category">
      Top Categoryüîù
      <div><span id="highest-category-value">N/A</span></div>
    </div>
    <div class="box orange" id="highest-amount">
      Max Spendüßæ
      <div>‚Çπ:<span id="highest-amount-value">0</span></div>
    </div>
  </section>

  <!-- MAIN CONTENT: EXPENSE LIST + ADD EXPENSE -->
  <section class="main-content">
    <!-- EXPENSE LIST -->
    <section class="expense-list">
      <h2>Expense List</h2>
      <div class="filter">
        <label>From: <input type="date" id="from-date" class="small-input" name="from-date" /></label>
        <label>To: <input type="date" id="to-date" class="small-input" name="to-date" /></label>
        <button id="filter-btn" class="hover-effect">üîç</button>
        <button id="refresh-btn" class="hover-effect">‚Üª</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Name</th>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount(‚Çπ)</th>
            <th>Edit/Delete</th>
            <th>Uploaded File</th>
          </tr>
        </thead>
        <tbody id="expense-table-body">
          <!-- Data dynamically added here -->
        </tbody>
      </table>
      
    </section>
    <!-- ADD EXPENSE FORM -->
    <section class="add-expense">
      <h2>Add Expense</h2>
      <form id="expense-form">
        <input type="hidden" id="expense-id" name="expense-id" />
        <label>Name: <input type="text" id="name" name="name" required /></label>
        <label>
          Category:
          <select id="category" name="category" required>
            <!-- Options go here; loaded by script -->
          </select>
        </label>
        <label id="custom-category-label" style="display: none;">
          Other Category: <input type="text" id="custom-category" name="custom-category" />
        </label>
        <label>
          Category Description: <input type="text" id="category-desc" name="category-desc" />
        </label>
        <label>Date: <input type="date" id="date" name="date" required /></label>
        <label>Amount(‚Çπ): <input type="number" id="amount" name="amount" min="1" required /></label>
        <label>Description: <textarea id="description" name="description"></textarea></label>
        <label for="file-upload" id="file-upload-label" class="file-upload-label">Upload Fileüì§</label>
        <input type="file" id="file-upload" name="file-upload" accept=".jpg,.png,.pdf,.jpeg,.doc,.docx,.xlsx" />
        <button type="submit" class="hover-effect">SUBMIT</button>
      </form>
    </section>
  </section>

  <!-- SET MONTH & YEAR SECTION (WITH NEW CATEGORY & AMOUNT) -->
  <h1 class="budget-heading">Budget‚Äîthe Fantasy Edition</h1>
  <section class="set-month-year">
    <!-- LEFT: Month & Year -->
    <div class="month-year-left">
      <h2>Set Year and Month</h2>
      <div id="month-year-prompt" class="prompt" style="display: none;">
        ‚ö†Ô∏è This month/year is already set!
      </div>
      <form id="month-year-form">
        <div class="form-group" style="display: flex; flex-direction: column; gap: 1rem;">
          <label>Year:
            <select id="year-select" required>
              <option value="">Select Year</option>
              <!-- Options populated by JavaScript -->
            </select>
          </label>
          <label>Month:
            <select id="month-select" required>
              <option value="">Select Month</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </label>
          <button type="submit" class="hover-effect">Set</button>
        </div>
      </form>
    </div>
    <!-- RIGHT: Category & Amount (Direct Options via Radio Buttons) -->
    <div id="budget-form-container" class="budget-form-container">
      <h3>Set Category & Amount</h3>
      <form id="budget-category-form">
        <div class="budget-form-inner">
          <fieldset>
            <legend>Category:</legend>
            <label>
              <input type="radio" name="budget-category" value="Foodüçï" required>
              <span class="radio-label">Foodüçï</span>
            </label>
            <label>
              <input type="radio" name="budget-category" value="TransportüöÇ">
              <span class="radio-label">TransportüöÇ</span>
            </label>
            <label>
              <input type="radio" name="budget-category" value="Billsüí∏">
              <span class="radio-label">Billsüí∏</span>
            </label>
            <label>
              <input type="radio" name="budget-category" value="Entertainmentü§°">
              <span class="radio-label">Entertainmentü§°</span>
            </label>
            <label>
              <input type="radio" name="budget-category" value="ShoppingüõçÔ∏è">
              <span class="radio-label">ShoppingüõçÔ∏è</span>
            </label>
            <label>
              <input type="radio" name="budget-category" value="Therapy ü©∫">
              <span class="radio-label">Therapy ü©∫</span>
            </label>
            <label>
              <input type="radio" name="budget-category" value="Others">
              <span class="radio-label">Others</span>
            </label>
          </fieldset>
          <label for="budget-amount">Amount(‚Çπ):
            <input type="number" id="budget-amount" name="budget-amount" required min="1" />
          </label>
          <button type="submit" class="hover-effect">Save Budget</button>
        </div>
      </form>
    </div>
  </section>
  <section class="budget-list">
    <h2>Budget List</h2>
    <table>
      <thead>
        <tr>
          <th>Year</th>
          <th>Month</th>
          <th>Category</th>
          <th>Amount(‚Çπ)</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="budget-table-body">
        <!-- Data dynamically added here -->
      </tbody>
    </table>
  </section>




  <!-- Team 4 -->
  <div class="container">
    <h1>My Expenses</h1>
    
    <div class="chart-container">
        <div class="graph">
            <h3>Monthly Expenses</h3>
            <img style="margin-top: 40px;" src="data:image/png;base64,{{ monthly_plot }}" alt="Monthly Expenses Graph">
        </div>
        
        <div class="graph">
            <h3>Filter Expenses by Category</h3>
            <div class="filter-container">
                <select id="year" onchange="updateCategoryPlot() ">
                    <option value="2024" {% if default_year == 2024 %}selected{% endif %}>2024</option>
                    <option value="2025" {% if default_year == 2025 %}selected{% endif %}>2025</option>
                </select>

                <select id="month" onchange="updateCategoryPlot()">
                    {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if default_month == i %}selected{% endif %}>
                            {{ ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][i-1] }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <img id="categoryChart" src="data:image/png;base64,{{ category_plot }}" alt="Category-wise Expenses Graph">
        </div>
    </div>
        <div class = "container2">
            <h1>Family Expenses</h1>
            <div class="filter-container">
                <select id="pieUser">
                    {% for user in users %}
                        <option value="{{ user }}" {% if user == default_user %}selected{% endif %}>
                            {{ user }}
                        </option>
                    {% endfor %}
                </select>
            
                <select id="pieYear">
                    <option value="2024" {% if default_year == 2024 %}selected{% endif %}>2024</option>
                    <option value="2025" {% if default_year == 2025 %}selected{% endif %}>2025</option>
                </select>
            
                <select id="pieMonth">
                    {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if default_month == i %}selected{% endif %}>
                            {{ ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][i-1] }}
                        </option>
                    {% endfor %}
                </select>
            
                <button onclick="updateCharts()">Apply Filters</button>
            </div>
            <div class="chart-container2">
            <div class="graph">
                <h3>Budget vs Expenses</h3>          
                <img id="pieChart" src="data:image/png;base64,{{ pie_chart }}" alt="Budget vs Expenses Pie Chart">
            </div>
            <div class="graph">
                <h3>Spending Progress by Category</h3>
                <img id="barChart" src="data:image/png;base64,{{ bar_chart }}" alt="Spending Progress Chart">
            </div>
            <div class="graph">
                <h3>Family Member's Expenses By Category</h3>
                <img id="stackedBarChart" src="data:image/png;base64,{{ stacked_bar_chart }}" alt="Stacked Bar Chart">
            </div>                             
            <div class="graph">
                <h3>Budget vs. Expense (Line Chart)</h3>
                <img id="lineChart" src="data:image/png;base64,{{ line_chart }}" alt="Budget vs. Expense Line Chart">
            </div>
            
        </div>
    </div>

<script>
    function updateCategoryPlot() {
        const year = document.getElementById("year").value;
        const month = document.getElementById("month").value;
    
        fetch(`/plot/category_data/${year}/${month}`)
            .then(response => response.json())
            .then(data => {
                if (data.no_data) {
                    alert("Insufficient data available for the selected month and year.");
                } else {
                    document.getElementById("categoryChart").src = "data:image/png;base64," + data.category_plot;
                }
            })
            .catch(error => console.error("Error updating chart:", error));
    }
    
    async function updateLineChart(user, year) {
    try {
        const response = await fetch(`/plot/line_chart/${year}?user=${encodeURIComponent(user)}`);
        const data = await response.json();
        document.getElementById("lineChart").src = "data:image/png;base64," + data.line_chart;
    } catch (error) {
        console.error("Error updating line chart:", error);
    }
}
    
    document.addEventListener("DOMContentLoaded", function () {
        updateCharts();  // Load default charts when page loads
    });

    async function updateCharts() {
    const user = document.getElementById("pieUser").value;
    const year = document.getElementById("pieYear").value;
    const month = document.getElementById("pieMonth").value;

    try {
        let noData = false;

        // Update Pie Chart
        const pieResponse = await fetch(`/plot/pie_chart/${year}/${month}?user=${encodeURIComponent(user)}`);
        const pieData = await pieResponse.json();
        if (pieData.no_data) noData = true;
        else document.getElementById("pieChart").src = "data:image/png;base64," + pieData.pie_chart;

        // Update Bar Chart
        const barResponse = await fetch(`/plot/bar_chart/${year}/${month}?user=${encodeURIComponent(user)}`);
        const barData = await barResponse.json();
        if (barData.no_data) noData = true;
        else document.getElementById("barChart").src = "data:image/png;base64," + barData.bar_chart;

        // Update Stacked Bar Chart
        const stackedResponse = await fetch(`/plot/stacked_bar_chart/${year}/${month}`);
        const stackedData = await stackedResponse.json();
        if (stackedData.no_data) noData = true;
        else document.getElementById("stackedBarChart").src = "data:image/png;base64," + stackedData.stacked_bar_chart;

        // Update Line Chart with the selected year and user
        await updateLineChart(user, year);  // Pass user and year to updateLineChart

        if (noData) {
            alert("Insufficient data available for the selected month and year.");
        }

    } catch (error) {
        console.error("Error updating charts:", error);
    }
}
   
</script>
</body>
</html>
